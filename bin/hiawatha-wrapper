#!/bin/sh

# Enable the use of the HTTP_DOMAIN envirnmental variable
if [ -z "$HTTP_DOMAIN" ]; then
	DOMAIN="domain"
else
	DOMAIN="$HTTP_DOMAIN"
fi

if ! [ -e /var/www/$DOMAIN ]; then # Need to add the site

# Check for certificate verification for Lets Encrypt
if [ -n "$HTTP_CERT_PROXY_HOST" ]; then
	certHost="-c$HTTP_CERT_PROXY_HOST"
else
	certHost=""
fi

# Check to see if the site is a reverse proxy for another site.
if [ -n "$HTTP_PROXY_HOST" ]; then
	proxyHost="-p$HTTP_PROXY_HOST"
else
	proxyHost=""
fi

# Handle SSL support
if [ -e /certs/$DOMAIN.pem ]; then
	/usr/bin/setupSSL "$DOMAIN"
	# Read TLS environmental variable
	if [ -n "$HTTP_REQUIRE_TLS" ] && [ "$HTTP_REQUIRE_TLS" = "yes" ]; then
		/usr/bin/addSite -t $certHost $proxyHost $DOMAIN
	else
		/usr/bin/addSite $certHost $proxyHost $DOMAIN
	fi
else
	/usr/bin/addSite $certHost $proxyHost $DOMAIN
fi

fi

# Run hiawatha in the foreground.
/usr/sbin/hiawatha -d -c /etc/hiawatha
